<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <mapper namespace="shop">
 	
 	<!-- 매장목록조회-->
 	<select id="list" parameterType="map" resultType="shopDto">
		select * from
	    (select rownum rn, TMP.* from 
	        (select * from shop
 			where no between #{start} and #{end}
 			<if test="cat_no > 0">
 				and category = #{cat_no}
 			</if>)TMP
	    )
		where rn between 1 and 10
 	</select>
 	
 	<!-- 카테고리 목록 -->
 	<select id="category" resultType="foodCategoryDto">
 		select * from food_category order by sort_seq
 	</select>
 	
 	<!-- 매장상세 매장정보 -->
 	<select id="shop_info" parameterType="int" resultType="shopDto">
 		select * from shop where no=#{no}
 	</select>
 	
 	<!--매장상세 메뉴목록 -->
 	<select id="menu" parameterType="int" resultType="menuDto">
 		select * from menu where shop_code=#{no}
 	</select>
 	
 	<!-- 서브메뉴 메뉴명 -->
 	<select id="menu_name" parameterType="int" resultType="menuDto">
 		select * from menu where no=#{menu_no}
 	</select>
 	
 	<!--매장상세 메뉴목록 -->
 	<select id="sub_menu" parameterType="int" resultType="subMenuDto">
 		select * from sub_menu where menu_code=#{menu_no}
 	</select>
 
 	<insert id="regist" parameterType="shopDto">
 		insert into shop values(shop_seq.nextval,#{category},#{company_name},#{company_code},#{ceo},#{ceo_phone},
 						#{bank},#{account_number},#{account_name},#{shop_name},#{shop_phone},#{zip_code},
 						#{basic_addr},#{detail_addr},#{content},sysdate,null,null,
 						null,'대기',#{min_price},#{min_time},#{delivery_price}
 						,TO_DATE(#{start_time},'HH24:MI'),TO_DATE(#{finish_time},'HH24:MI'),null,#{location_y},#{location_x},#{shop_img},#{business_regist},#{sale_regist})
 	</insert>
 	
 	<select id="getno" parameterType="shopDto" resultType="int">
 		select no from shop where company_name = #{company_name}
 	</select>
 	
 	<insert id="files_regist" parameterType="filesDto">
 		insert into files values(#{no},#{file_type},#{upload_name},#{save_name},
 								#{size},sysdate,sysdate)
 	</insert>
 	<select id="seq" resultType="int">
		select files_seq.nextval from dual
	</select>
	<update id="edit" parameterType="shopDto">
		update shop
			set
				category = #{category},
				company_name = #{company_name},
				company_code = #{company_code},
				ceo = #{ceo},
				ceo_phone = #{ceo_phone},
				bank = #{bank},
				account_number = #{account_number},
				account_name = #{account_name},
				shop_name = #{shop_name},
				shop_phone = #{shop_phone},
				zip_code = #{zip_code},
				basic_addr = #{basic_addr},
				detail_addr = #{detail_addr},
				min_price = #{min_price},
				delivery_price = #{delivery_price},
				start_time = TO_DATE(#{start_time},'HH24:MI'),
				finish_time = TO_DATE(#{finish_time},'HH24:MI'),
				shop_img = #{shop_img}
			where
				no = #{no} 
	</update>
	
	<select id="list_shop" resultType="shopDto" parameterType="map">
		select * from shop
		<include refid="search"></include>	
	</select>
	
	
	
	
	<select id="listAll" resultType="shopDto" parameterType="map">
	<include refid="pagingHeader"></include>
		select * from shop
		<include refid="search"></include>
		order by no desc
		<include refid="pagingFooter"></include>
	</select>
	
	<!-- 검색 조건 sql -->
	<sql id="search">
		<choose>
		<!-- 검색조건이 전제 검색일 때 -->
			<when test="searchOption == 'all'">
				where category like '%'||#{keyword}||'%'
				or COMPANY_NAME like '%'||#{keyword}||'%'
				or reason like '%'||#{keyword}||'%'
			</when>
		<!-- 검색조건이 전제 검색이 아닐 때 -->	
			<otherwise>
				where ${searchOption} like '%'||#{keyword}||'%'
			</otherwise>
		</choose>
	
	</sql>
	<!-- 페이징 sql -->
	<sql id="pagingHeader">
		select * from (select rownum as rn,A.* from(
	</sql>
	
	<sql id="pagingFooter">
		)A
	)where rn between #{start} and #{end}
	</sql>
	<select id="category_no" resultType="foodCategoryDto">
		select * from food_category
	</select>
	<select id="category_name" resultType="foodCategoryDto" parameterType="map">
		select * from food_category where name = #{name}
	</select>
	
	
	<select id="myshop" resultType="shopDto" parameterType="map">
		select * from shop where no = #{no}
	</select>

	<select id="all" resultType="shopDto">
		select * from shop 
	</select>
	<select id="search_name" resultType="shopDto" parameterType="map">
		select * from shop where shop_name like '%'||#{shop_name}||'%'
	</select>
	
	<!-- 매장관리에서 승인버튼 클릭시 -->
	<update id="apply_shop" parameterType="int">
		update shop set apply_status='승인완료' where no=#{shop_code}
	</update>
	
 </mapper>